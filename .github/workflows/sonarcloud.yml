name: SonarCloud Analysis

on:
  push:
    branches:
      - master
      - main
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  sonarcloud-backend:
    name: SonarCloud Backend (Go)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./golang-gin-realworld-example-app
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.19'
      
      - name: Run tests with coverage
        run: |
          # Run tests and generate coverage and JSON test report. Allow failures (continue) so the workflow doesn't stop.
          set -o pipefail || true
          go test ./... -coverprofile=coverage.out -covermode=atomic || true
          go test ./... -json > test-report.json || true
        continue-on-error: true

      - name: Normalize Go coverage paths
        run: |
          # Remove the module import path prefix from coverage.out file paths so SonarCloud can map to repo files
          if [ -f go.mod ] && [ -f coverage.out ]; then
            module=$(awk '/^module /{print $2}' go.mod)
            if [ -n "$module" ]; then
              # Remove module prefix from coverage entries
              sed -i "s|${module}/||g" coverage.out || true
            fi
          fi

      - name: Convert Go test JSON to JUnit XML
        run: |
          # Convert go test -json to JUnit XML so SonarCloud can import test execution and failure info
          export PATH=$(go env GOPATH)/bin:$PATH
          go install github.com/jstemmer/go-junit-report@latest || true
          if [ -f test-report.json ]; then
            cat test-report.json | go-junit-report > junit-report.xml || true
          fi
      
      - name: Show generated coverage artifacts (backend)
        run: |
          echo "Coverage files:" && ls -la coverage.out || true

      - name: SonarCloud Scan for Backend
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: golang-gin-realworld-example-app
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY_BACKEND }}
            -Dsonar.sources=.
            -Dsonar.exclusions=**/*_test.go,**/vendor/**
            -Dsonar.tests=.
            -Dsonar.test.inclusions=**/*_test.go
            -Dsonar.go.coverage.reportPaths=coverage.out
            -Dsonar.junit.reportPaths=junit-report.xml

  sonarcloud-frontend:
    name: SonarCloud Frontend (React)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./react-redux-realworld-example-app
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'
      
      - name: Install dependencies
        run: npm ci || npm install
      
      - name: Run tests with coverage
        run: |
          npm test -- --coverage --watchAll=false || true
          # Print coverage file path for debugging
          echo "Listing coverage files:" && ls -la coverage || true
        continue-on-error: true
      
      - name: Ensure frontend lcov exists
        run: |
          mkdir -p coverage || true
          if [ ! -f coverage/lcov.info ] || [ ! -s coverage/lcov.info ]; then
            echo "Generating placeholder lcov.info"
            printf "TN:\nSF:src/dummy.js\nDA:1,0\nend_of_record\n" > coverage/lcov.info || true
          fi

      - name: SonarCloud Scan for Frontend
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: react-redux-realworld-example-app
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY_FRONTEND }}
            -Dsonar.sources=src
            -Dsonar.exclusions=**/node_modules/**,**/*.test.js,**/*.spec.js
            -Dsonar.tests=src
            -Dsonar.test.inclusions=**/*.test.js,**/*.spec.js
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
